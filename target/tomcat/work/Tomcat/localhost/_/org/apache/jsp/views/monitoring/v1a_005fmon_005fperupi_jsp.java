/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/7.0.47
 * Generated at: 2025-07-10 06:27:18 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp.views.monitoring;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;

public final class v1a_005fmon_005fperupi_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private javax.el.ExpressionFactory _el_expressionfactory;
  private org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public void _jspInit() {
    _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
    _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
        throws java.io.IOException, javax.servlet.ServletException {

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html;charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n");
      out.write("\r\n");
      out.write("<style>\r\n");
      out.write("   /* CSS TABLE REKAP - SAMAKAN DENGAN TABEL Detail */\r\n");
      out.write("    #tablemon_upi {\r\n");
      out.write("        table-layout: auto; /* Sama seperti #dataModal table */\r\n");
      out.write("        font-size: 0.75rem; /* Sama dengan modal-body */\r\n");
      out.write("        width: 100%;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #tablemon_upi th,\r\n");
      out.write("    #tablemon_upi td {\r\n");
      out.write("        font-size: 0.7rem;      /* Sama seperti table detail */\r\n");
      out.write("        padding: 4px 6px;       /* Sama seperti table detail */\r\n");
      out.write("        white-space: nowrap;    /* Hindari wrap */\r\n");
      out.write("        overflow: hidden;\r\n");
      out.write("        text-overflow: ellipsis;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #tablemon_upi th.sorting::after,\r\n");
      out.write("    #tablemon_upi th.sorting_asc::after,\r\n");
      out.write("    #tablemon_upi th.sorting_desc::after {\r\n");
      out.write("        display: none !important;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* Tambahan jika mau batas tinggi + scroll seperti modal */\r\n");
      out.write("    #tablemon_upi_wrapper .dataTables_scrollBody {\r\n");
      out.write("        max-height: 65vh;       /* Sesuaikan tinggi maksimal seperti modal */\r\n");
      out.write("        overflow-y: auto;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* CSS MODAL SHOW TABLE MONITORING Detail */\r\n");
      out.write("    #dataModal .modal-body {\r\n");
      out.write("        font-size: 0.75rem; /* Ukuran teks diperkecil */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #dataModal table th,\r\n");
      out.write("    #dataModal table td {\r\n");
      out.write("        font-size: 0.7rem;   /* Ukuran teks header dan isi tabel */\r\n");
      out.write("        padding: 4px 6px;    /* Padding dikurangi agar tidak terlalu lebar */\r\n");
      out.write("        white-space: nowrap; /* Hindari pemisahan baris */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #dataModal table {\r\n");
      out.write("        table-layout: auto; /* Gunakan auto agar kolom menyesuaikan konten */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #dataModal .datatable-container {\r\n");
      out.write("        max-height: 65vh;    /* Batasi tinggi agar bisa scroll */\r\n");
      out.write("        overflow-y: auto;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* Pastikan form-container relatif */\r\n");
      out.write("    .form-monitoring {\r\n");
      out.write("        position: relative;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    .datatable-container {\r\n");
      out.write("        overflow-x: auto;\r\n");
      out.write("        width: 100%;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* Buat spinner tetap di tengah form tapi transparan */\r\n");
      out.write("    .loading-overlay {\r\n");
      out.write("        position: absolute;\r\n");
      out.write("        top: 50%;\r\n");
      out.write("        left: 50%;\r\n");
      out.write("        transform: translate(-50%, -50%);\r\n");
      out.write("        z-index: 1050;\r\n");
      out.write("        text-align: center;\r\n");
      out.write("        font-size: 0.95rem;\r\n");
      out.write("        /* Tidak ada background, padding, atau box */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* tambah lebar large modal */\r\n");
      out.write("    .modal-xxl {\r\n");
      out.write("        max-width: 98% !important; /* Atur sesuai kebutuhan */\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* legenda tulisan hedar dan kotak  */\r\n");
      out.write("    .form-box {\r\n");
      out.write("        border: 1px solid #ddd;\r\n");
      out.write("        border-radius: 4px;\r\n");
      out.write("        padding: 20px;\r\n");
      out.write("        margin: 20px 0;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    .form-box legend {\r\n");
      out.write("        font-weight: bold;\r\n");
      out.write("        font-size: 1rem;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    .form-box fieldset {\r\n");
      out.write("        border: none;\r\n");
      out.write("        padding: 0;\r\n");
      out.write("        margin: 0;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    #bln_usulan {\r\n");
      out.write("        text-transform: uppercase;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    /* ----------\r\n");
      out.write("       Spiner css\r\n");
      out.write("       ----------\r\n");
      out.write("    */\r\n");
      out.write("    #loadingSpinner {\r\n");
      out.write("        display: none;\r\n");
      out.write("        position: fixed;\r\n");
      out.write("        top: 20%;\r\n");
      out.write("        left: 50%;\r\n");
      out.write("        transform: translate(-50%, 0);\r\n");
      out.write("        z-index: 9999;\r\n");
      out.write("        /* background-color: rgba(255, 255, 255, 0.7); */\r\n");
      out.write("        padding: 20px 30px;\r\n");
      out.write("        border-radius: 6px;\r\n");
      out.write("        /* box-shadow: 0 0 10px rgba(0,0,0,0.2); */\r\n");
      out.write("        text-align: center;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("    #loadingSpinner .spinner-content {\r\n");
      out.write("        text-align: center;\r\n");
      out.write("        font-size: 1.2rem;\r\n");
      out.write("        color: #333;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("    .overlay-spinner {\r\n");
      out.write("        position: absolute;\r\n");
      out.write("        top: 40%;\r\n");
      out.write("        left: 45%;\r\n");
      out.write("        z-index: 1060;\r\n");
      out.write("    }\r\n");
      out.write("\r\n");
      out.write("</style>\r\n");
      out.write("\r\n");
      out.write("<!-- ✅ Spinner Global untuk semua loading -->\r\n");
      out.write("<div id=\"spinnerOverlay\" style=\"display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:9999;\">\r\n");
      out.write("    <div class=\"spinner-border text-primary\" role=\"status\"></div>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("<!-- Modal Large -->\r\n");
      out.write("<div class=\"modal fade\" id=\"dataModal\" tabindex=\"-1\" aria-labelledby=\"dataModalLabel\" aria-hidden=\"true\">\r\n");
      out.write("  <!-- <div class=\"modal-dialog modal-dialog-scrollable modal-xl\"> -->\r\n");
      out.write("  <div class=\"modal-dialog modal-dialog-scrollable modal-xl modal-xxl\">\r\n");
      out.write("    <div class=\"modal-content\">\r\n");
      out.write("        <div class=\"modal-header\">\r\n");
      out.write("            <h5 class=\"modal-title\" id=\"dataModalLabel\">Detail Data</h5>\r\n");
      out.write("            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Tutup\"></button>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"modal-body\" id=\"modalBody\">\r\n");
      out.write("            <!-- Tombol Export -->\r\n");
      out.write("            <div class=\"mb-2\">\r\n");
      out.write("                <button id=\"btnExportMonDftAllExcelOneSheet\" class=\"btn btn-success btn-export\">\r\n");
      out.write("                    <i class=\"fa fa-file-excel-o\"></i> Export Detail Per-UPI\r\n");
      out.write("                </button>\r\n");
      out.write("            </div>\r\n");
      out.write("        <div class=\"datatable-container\" style=\"overflow-x: auto;\">\r\n");
      out.write("        <table id=\"table_mondaf_upi\" class=\"table table-bordered table-striped w-100\" width=\"100%\">\r\n");
      out.write("                <thead>\r\n");
      out.write("                <tr>\r\n");
      out.write("                    <th>NO</th>\r\n");
      out.write("                    <!-- <th>TOTAL_COUNT</th> -->\r\n");
      out.write("                    <!-- <th>URUT</th> -->\r\n");
      out.write("                    <th>PRODUK</th>\r\n");
      out.write("                    <th>TGLAPPROVE</th>\r\n");
      out.write("                    <th>KD_DIST</th>\r\n");
      out.write("                    <th>VA</th>\r\n");
      out.write("                    <th>SATKER</th>\r\n");
      out.write("                    <th>PLN_NOUSULAN</th>\r\n");
      out.write("                    <!-- <th>PLN_KDPROSES</th>\r\n");
      out.write("                    <th>PLN_STATUS</th> -->\r\n");
      out.write("                    <th>PLN_IDPEL</th>\r\n");
      out.write("                    <th>PLN_BLTH</th>\r\n");
      out.write("                    <th>PLN_LUNAS_H0</th>\r\n");
      out.write("                    <th>PLN_RPTAG</th>\r\n");
      out.write("                    <th>PLN_RPBK</th>\r\n");
      out.write("                    <th>PLN_TGLBAYAR</th>\r\n");
      out.write("                    <th>PLN_JAMBAYAR</th>\r\n");
      out.write("                    <th>PLN_USERID</th>\r\n");
      out.write("                    <th>PLN_KDBANK</th>\r\n");
      out.write("                    <!-- <th>BANK_KETERANGAN</th> -->\r\n");
      out.write("                    <th>BANK_NOUSULAN</th>\r\n");
      out.write("                    <th>BANK_IDPEL</th>\r\n");
      out.write("                    <th>BANK_BLTH</th>\r\n");
      out.write("                    <th>BANK_RPTAG</th>\r\n");
      out.write("                    <th>BANK_RPBK</th>\r\n");
      out.write("                    <th>BANK_TGLBAYAR</th>\r\n");
      out.write("                    <th>BANK_JAMBAYAR</th>\r\n");
      out.write("                    <th>BANK_USERID</th>\r\n");
      out.write("                    <th>BANK_KDBANK</th>\r\n");
      out.write("                    <th>SELISIH_RPTAG</th>\r\n");
      out.write("                    <th>SELISIH_BK</th>\r\n");
      out.write("                    <th>KETERANGAN</th>\r\n");
      out.write("                    <!-- <th>ROW_NUMBER</th> -->\r\n");
      out.write("                </tr>\r\n");
      out.write("                </thead>\r\n");
      out.write("            <tbody>\r\n");
      out.write("            </tbody>\r\n");
      out.write("          </table>\r\n");
      out.write("        </div>          \r\n");
      out.write("      </div>\r\n");
      out.write("      <div class=\"modal-footer\">\r\n");
      out.write("        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Tutup</button>\r\n");
      out.write("      </div>\r\n");
      out.write("    </div>\r\n");
      out.write("  </div>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("<fieldset style=\"border: 1px solid #ccc; border-radius: 4px; padding: 1.25rem;\">\r\n");
      out.write("    <legend style=\"font-size: 0.95rem; font-weight: bold; padding: 0 0.75rem; width: auto;\">\r\n");
      out.write("        Monitoring Rekon PLN Vs Bank\r\n");
      out.write("    </legend>\r\n");
      out.write("\r\n");
      out.write("    <div class=\"container mt-1\">\r\n");
      out.write("        <div class=\"form-monitoring\">\r\n");
      out.write("            <form id=\"form-monitoring\">\r\n");
      out.write("                <div class=\"row align-items-end g-3 mb-2\">\r\n");
      out.write("                    <!-- Input Bulan Laporan -->\r\n");
      out.write("                    <div class=\"col-md-4 col-lg-3\">\r\n");
      out.write("                        <label for=\"bln_usulan\" class=\"form-label\">Bulan Laporan :</label>\r\n");
      out.write("                        <div class=\"input-group\">\r\n");
      out.write("                            <input type=\"text\" id=\"bln_usulan\" class=\"form-control\" placeholder=\"Pilih Bulan Laporan\">\r\n");
      out.write("                            <span class=\"input-group-text\" id=\"calendarIcon\" style=\"cursor: pointer;\">\r\n");
      out.write("                                <i class=\"fa-solid fa-calendar-alt\"></i>\r\n");
      out.write("                            </span>\r\n");
      out.write("                        </div>\r\n");
      out.write("                    </div>\r\n");
      out.write("\r\n");
      out.write("                    <!-- Tombol Tampilkan -->\r\n");
      out.write("                    <div class=\"col-md-2\">\r\n");
      out.write("                        <label class=\"form-label d-none d-md-block\">&nbsp;</label> <!-- Spacer agar sejajar -->\r\n");
      out.write("                        <button id=\"btnTampil\" type=\"button\" class=\"btn btn-primary w-100\">\r\n");
      out.write("                            <i class=\"bi bi-search\"></i> Tampilkan\r\n");
      out.write("                        </button>\r\n");
      out.write("                    </div>\r\n");
      out.write("                </div>\r\n");
      out.write("            </form>\r\n");
      out.write("        </div>\r\n");
      out.write("\r\n");
      out.write("        <div class=\"mt-4\">\r\n");
      out.write("           <!-- Tombol export buatan sendiri -->\r\n");
      out.write("            <div class=\"mb-2\">\r\n");
      out.write("                <button id=\"btnExportMonRkpAllExcel\" class=\"btn btn-success btn-export\" style=\"display: none;\">\r\n");
      out.write("                    <i class=\"fa fa-file-excel-o\"></i> Download Excel\r\n");
      out.write("                </button>\r\n");
      out.write("                <button id=\"btnExportMonRkpAllExcel2\" class=\"btn btn-success btn-export\" >\r\n");
      out.write("                    <i class=\"fa fa-file-excel-o\"></i> Download Excel Rekap\r\n");
      out.write("                </button>\r\n");
      out.write("            </div>\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("            <div class=\"datatable-container\">\r\n");
      out.write("                <div class=\"datatable-scroll-wrapper\" style=\"overflow-x: auto;\">\r\n");
      out.write("                    <table id=\"tablemon_upi\" class=\"datatable-main table table-bordered table-striped\">\r\n");
      out.write("                        <thead>\r\n");
      out.write("                            <tr>\r\n");
      out.write("                                <th>NO</th>\r\n");
      out.write("                                <th>NAMA_DIST</th>\r\n");
      out.write("                                <th>PRODUK</th>\r\n");
      out.write("                                <th>BANK</th>\r\n");
      out.write("                                <th>BULAN</th>\r\n");
      out.write("                                <th>PLN_IDPEL</th>\r\n");
      out.write("                                <th>PLN_RPTAG</th>\r\n");
      out.write("                                <th>PLN_LB_LUNAS</th>\r\n");
      out.write("                                <th>PLN_RP_LUNAS</th>\r\n");
      out.write("                                <th>BANK_IDPEL</th>\r\n");
      out.write("                                <th>BANK_RPTAG</th>\r\n");
      out.write("                                <th>SELISIH_RPTAG</th>\r\n");
      out.write("                            </tr>\r\n");
      out.write("                        </thead>\r\n");
      out.write("                        <tbody></tbody>\r\n");
      out.write("                    </table>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</fieldset>\r\n");
      out.write("\r\n");
      out.write("<script>\r\n");
      out.write("    $(document).ready(function () {\r\n");
      out.write("        function getContextPath() {\r\n");
      out.write("            return window.location.pathname.substring(0, window.location.pathname.indexOf(\"/\", 2));\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        function convertBulanTahunToYYYYMM(str) {\r\n");
      out.write("            const date = new Date(str); // \"July 2025\" akan dikenali oleh Date\r\n");
      out.write("            const year = date.getFullYear();\r\n");
      out.write("            const month = String(date.getMonth() + 1).padStart(2, '0'); // bulan dimulai dari 0\r\n");
      out.write("            return year+month; // hasil: \"202507\"\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        // Inisialisasi flatpickr dengan locale Indonesia\r\n");
      out.write("        const blnUsulanInstance = flatpickr(\"#bln_usulan\", {\r\n");
      out.write("            locale: flatpickr.l10ns.id, // ✅ Ini cara yang benar\r\n");
      out.write("            plugins: [\r\n");
      out.write("                new monthSelectPlugin({\r\n");
      out.write("                    shorthand: false,\r\n");
      out.write("                    theme: \"light\"\r\n");
      out.write("                })\r\n");
      out.write("            ],\r\n");
      out.write("            dateFormat: \"Ym\",\r\n");
      out.write("            altInput: true,\r\n");
      out.write("            altFormat: \"F Y\",\r\n");
      out.write("            defaultDate: new Date()\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        // Saat ikon diklik, buka datepicker\r\n");
      out.write("        document.getElementById(\"calendarIcon\").addEventListener(\"click\", function () {\r\n");
      out.write("            blnUsulanInstance.open();\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        let detailFilterParams = {};\r\n");
      out.write("\r\n");
      out.write("        // memembat format number digit\r\n");
      out.write("        function formatNumber(value, fractionDigits = 2) {\r\n");
      out.write("            if (value == null || value === '') return '';\r\n");
      out.write("            const number = parseFloat(value);\r\n");
      out.write("            if (isNaN(number)) return value;\r\n");
      out.write("            return number.toLocaleString('id-ID', {\r\n");
      out.write("                minimumFractionDigits: fractionDigits,\r\n");
      out.write("                maximumFractionDigits: fractionDigits\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        // ---------------------------------------------------------------------------------------------\r\n");
      out.write("        // 1A-1) Tampilkan monitoring Rekap\r\n");
      out.write("        // ---------------------------------------------------------------------------------------------\r\n");
      out.write("        var table = $('#tablemon_upi').DataTable({\r\n");
      out.write("            processing: false,\r\n");
      out.write("            serverSide: true,\r\n");
      out.write("            scrollX: false,\r\n");
      out.write("            paging: false, // MATIKAN PAGING\r\n");
      out.write("            stripeClasses: [], // Nonaktifkan efek baris selang-seling\r\n");
      out.write("            searching: false, \r\n");
      out.write("            autoWidth: false,\r\n");
      out.write("            ajax: {\r\n");
      out.write("                url:  getContextPath() + '/mon-rekon-bankvsperupi',\r\n");
      out.write("                type: 'POST',\r\n");
      out.write("                data: function (d) {\r\n");
      out.write("                    d.vbln_usulan = convertBulanTahunToYYYYMM($('#bln_usulan').val());// pastikan pakai '#'!\r\n");
      out.write("                }\r\n");
      out.write("            },\r\n");
      out.write("            columns: [\r\n");
      out.write("                {\r\n");
      out.write("                    data: null,\r\n");
      out.write("                    render: function (data, type, row, meta) {\r\n");
      out.write("                        if (row.KD_DIST !== null && row.KD_DIST !== undefined) {\r\n");
      out.write("                            return meta.row + 1 + meta.settings._iDisplayStart;\r\n");
      out.write("                        } else {\r\n");
      out.write("                            return ''; // atau bisa juga 'N/A' atau '-'\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                // { data: 'KD_DIST' },\r\n");
      out.write("                // { data: 'NAMA_DIST' },\r\n");
      out.write("                // { data: 'URUT' },\r\n");
      out.write("                {\r\n");
      out.write("                    data: null,\r\n");
      out.write("                    render: function (data, type, row) {\r\n");
      out.write("                         if (!row.KD_DIST || !row.NAMA_DIST) {\r\n");
      out.write("                            return '';\r\n");
      out.write("                        } else {\r\n");
      out.write("                            return row.KD_DIST + ' - ' + row.NAMA_DIST;\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                { data: 'PRODUK',  defaultContent: '' },\r\n");
      out.write("                { data: 'BANK' ,  defaultContent: ''},\r\n");
      out.write("                { data: 'BLN_USULAN',  defaultContent: '' },\r\n");
      out.write("                { \r\n");
      out.write("                    data: 'PLN_IDPEL',  \r\n");
      out.write("                    render: function (data) {\r\n");
      out.write("                        return formatNumber(data, 0);\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                { \r\n");
      out.write("                    data: 'PLN_RPTAG',\r\n");
      out.write("                    render: function (data) {\r\n");
      out.write("                        return formatNumber(data, 0);\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                { \r\n");
      out.write("                    data: 'PLN_LEBAR_LUNAS',  \r\n");
      out.write("                     render: function (data) {\r\n");
      out.write("                        return formatNumber(data, 0);\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                { \r\n");
      out.write("                    data: 'PLN_RPTAG_LUNAS',  \r\n");
      out.write("                     render: function (data) {\r\n");
      out.write("                        return formatNumber(data, 0);\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                { \r\n");
      out.write("                    data: 'BANK_IDPEL',  \r\n");
      out.write("                     render: function (data) {\r\n");
      out.write("                        return formatNumber(data, 0);\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                { \r\n");
      out.write("                    data: 'BANK_RPTAG',  \r\n");
      out.write("                    render: function (data) {\r\n");
      out.write("                        return formatNumber(data, 0);\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                { \r\n");
      out.write("                    data: 'SELISIH_RPTAG',  \r\n");
      out.write("                    render: function (data) {\r\n");
      out.write("                        return formatNumber(data, 0);\r\n");
      out.write("                    }\r\n");
      out.write("                }\r\n");
      out.write("            ],\r\n");
      out.write("            drawCallback: function () {\r\n");
      out.write("                $('#tablemon_upi thead th').addClass('text-center');\r\n");
      out.write("            },\r\n");
      out.write("           columnDefs: [\r\n");
      out.write("                { targets: '_all', className: 'dt-center' },\r\n");
      out.write("                { targets: 0, className: 'dt-body-right', orderable: false, width: '30px' },       // No\r\n");
      out.write("                { targets: 1, className: 'dt-body-left', width: '250px' },                         // KD_DIST - NAMA_DIST\r\n");
      out.write("                { targets: 2, className: 'dt-body-center', width: '80px' },                       // PRODUK\r\n");
      out.write("                { targets: 3, className: 'dt-body-left', width: '200px' },                         // BANK\r\n");
      out.write("                { targets: 4, className: 'dt-body-center', width: '70px' },                        // BULAN\r\n");
      out.write("                { targets: 5, className: 'dt-body-right', width: '100px' },                        // PLN_IDPEL\r\n");
      out.write("                { targets: 6, className: 'dt-body-right', width: '120px' },                        // PLN_RPTAG\r\n");
      out.write("                { targets: 7, className: 'dt-body-right', width: '100px' },                        // PLN_LEBAR_LUNAS\r\n");
      out.write("                { targets: 8, className: 'dt-body-right', width: '120px' },                        // PLN_RPTAG_LUNAS\r\n");
      out.write("                { targets: 9, className: 'dt-body-right', width: '100px' },                        // BANK_IDPEL\r\n");
      out.write("                { targets: 10, className: 'dt-body-right', width: '120px' },                       // BANK_RPTAG\r\n");
      out.write("                { targets: 11, className: 'dt-body-right', width: '120px' }                        // SELISIH_RPTAG\r\n");
      out.write("            ],\r\n");
      out.write("            createdRow: function (row, data, dataIndex) {\r\n");
      out.write("               if (data.URUT == 5) {\r\n");
      out.write("                    $('td', row).css({\r\n");
      out.write("                        'font-weight': 'bold',\r\n");
      out.write("                        // 'background-color': 'black',\r\n");
      out.write("                        // 'color': 'white'\r\n");
      out.write("                    });\r\n");
      out.write("                }\r\n");
      out.write("\r\n");
      out.write("                $('td', row).each(function (colIndex) {\r\n");
      out.write("                    // Kolom pertama (No) tidak memiliki properti `data`\r\n");
      out.write("                    const columnDef = table.settings()[0].aoColumns[colIndex];\r\n");
      out.write("                    const columnName = columnDef.data;\r\n");
      out.write("\r\n");
      out.write("                    // Lewati jika tidak punya nama kolom\r\n");
      out.write("                    if (!columnName || columnName === null) return;\r\n");
      out.write("\r\n");
      out.write("                    const cellValue = data[columnName];\r\n");
      out.write("\r\n");
      out.write("                    const allowedColumns = ['PLN_IDPEL', 'PLN_RPTAG'];\r\n");
      out.write("\r\n");
      out.write("                    if (\r\n");
      out.write("                        allowedColumns.includes(columnName) &&\r\n");
      out.write("                        typeof cellValue === 'string' &&\r\n");
      out.write("                        cellValue.trim() !== '' &&\r\n");
      out.write("                        (data.URUT == 1 || data.URUT == 2 || data.URUT == 3)\r\n");
      out.write("                    ) {\r\n");
      out.write("                        $(this).css({\r\n");
      out.write("                            'cursor': 'pointer',\r\n");
      out.write("                            'text-decoration': 'underline',\r\n");
      out.write("                            'color': 'blue'\r\n");
      out.write("                        }).off('click').on('click', function () {\r\n");
      out.write("                            $('#xbln_usulan').val(data.BLN_USULAN);\r\n");
      out.write("                            $('#xkd_dist').val(data.KD_DIST);\r\n");
      out.write("\r\n");
      out.write("                            // Update filter\r\n");
      out.write("                            detailFilterParams = {\r\n");
      out.write("                                vbln_usulan: data.BLN_USULAN,\r\n");
      out.write("                                vkd_bank: data.BANK ? data.BANK.substring(0, 3) : '',\r\n");
      out.write("                                vkd_dist: data.KD_DIST\r\n");
      out.write("                            };\r\n");
      out.write("\r\n");
      out.write("                            console.log('Updated filter params:', detailFilterParams);\r\n");
      out.write("                            $('#dataModal').modal('show');\r\n");
      out.write("                        });\r\n");
      out.write("                    }\r\n");
      out.write("                });\r\n");
      out.write("            },\r\n");
      out.write("            // dom: 'lfrtip'\r\n");
      out.write("            dom: 'Bfrtip',\r\n");
      out.write("            buttons: [\r\n");
      out.write("                    {\r\n");
      out.write("                        extend: 'excelHtml5',\r\n");
      out.write("                        title: 'MIV_REKON_REKAP_' + convertBulanTahunToYYYYMM($('#bln_usulan').val()),\r\n");
      out.write("                        className: 'd-none',\r\n");
      out.write("                        exportOptions: {\r\n");
      out.write("                            format: {\r\n");
      out.write("                                body: function (data, row, column, node) {\r\n");
      out.write("                                    // Ambil semua kolom yang menggunakan formatNumber\r\n");
      out.write("                                    const columnsRaw = [5,6,7,8,9,10,11]; // indeks kolom sesuai urutan kolom PLN_IDPEL - SELISIH_RPTAG\r\n");
      out.write("\r\n");
      out.write("                                    // Jika kolom termasuk dalam Detail, hilangkan format ribuan (misal: \"1.000.000\" jadi \"1000000\")\r\n");
      out.write("                                    if (columnsRaw.includes(column)) {\r\n");
      out.write("                                        if (typeof data === 'string') {\r\n");
      out.write("                                            // Hilangkan titik ribuan dan koma desimal jika perlu\r\n");
      out.write("                                            return data.replace(/\\./g, '').replace(/,/g, '');\r\n");
      out.write("                                        }\r\n");
      out.write("                                        return data;\r\n");
      out.write("                                    }\r\n");
      out.write("                                    return data;\r\n");
      out.write("                                }\r\n");
      out.write("                            }\r\n");
      out.write("                        },\r\n");
      out.write("                        customize: function (xlsx) {\r\n");
      out.write("                            const sheet = xlsx.xl.worksheets['sheet1.xml'];\r\n");
      out.write("                            const sheetData = $('sheetData', sheet);\r\n");
      out.write("\r\n");
      out.write("                            const now = new Date();\r\n");
      out.write("                            const dd = String(now.getDate()).padStart(2, '0');\r\n");
      out.write("                            const mm = String(now.getMonth() + 1).padStart(2, '0');\r\n");
      out.write("                            const yyyy = now.getFullYear();\r\n");
      out.write("                            const hh = String(now.getHours()).padStart(2, '0');\r\n");
      out.write("                            const mi = String(now.getMinutes()).padStart(2, '0');\r\n");
      out.write("                            const ss = String(now.getSeconds()).padStart(2, '0');\r\n");
      out.write("                            const timestamp = dd+\"/\"+mm+\"/\"+yyyy+\" \"+hh+\":\"+mi+\":\"+ss;\r\n");
      out.write("                            const judul = \"MIV_REKAP_\" + convertBulanTahunToYYYYMM($('#bln_usulan').val());\r\n");
      out.write("\r\n");
      out.write("                            // Tambahkan judul dan timestamp jika dibutuhkan\r\n");
      out.write("                            // ...\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                ]            \r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        // Tampilkan spinnerOverlay saat DataTables mulai load data\r\n");
      out.write("        table.on('preXhr.dt', function () {\r\n");
      out.write("           $('#spinnerOverlay').show();  \r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        // Sembunyikan spinnerOverlay setelah DataTables selesai load data\r\n");
      out.write("        table.on('xhr.dt', function () {\r\n");
      out.write("            $('#spinnerOverlay').hide();    // Saat selesai\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        $('#btnTampil').on('click', function () {\r\n");
      out.write("            if (!$('#bln_usulan').val()) {\r\n");
      out.write("                alert(\"Silakan pilih Bulan Usulan terlebih dahulu!\");\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            $('#spinnerOverlay').show();   // hanya tampilkan overlay modal\r\n");
      out.write("            table.ajax.reload();\r\n");
      out.write("        });\r\n");
      out.write("         \r\n");
      out.write("        // ---------------------------------------------------------------------------------------------\r\n");
      out.write("        // 1A-2) Ekspor halaman Monitoring Rekap ke Excel\r\n");
      out.write("        // ---------------------------------------------------------------------------------------------\r\n");
      out.write("        $('#btnExportMonRkpAllExcel').on('click', function () {\r\n");
      out.write("            table.button('.buttons-excel').trigger();\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        $('#btnExportMonRkpAllExcel2').on('click', async function () {\r\n");
      out.write("            const btn = $(this);\r\n");
      out.write("            let totalLoaded = 0;\r\n");
      out.write("\r\n");
      out.write("            $('#spinnerOverlay').show();\r\n");
      out.write("            await new Promise(resolve => setTimeout(resolve, 30));\r\n");
      out.write("\r\n");
      out.write("            btn.prop('disabled', true).text(\"Memuat... (\" + formatRibuan(totalLoaded) + \" data)\");\r\n");
      out.write("\r\n");
      out.write("            const vbln_usulan = convertBulanTahunToYYYYMM($('#bln_usulan').val());\r\n");
      out.write("            // const vbln_usulan = detailFilterParams.vbln_usulan;\r\n");
      out.write("\r\n");
      out.write("            if (!vbln_usulan) {\r\n");
      out.write("                alert('Silakan lengkapi Bulan Usulan terlebih dahulu!');\r\n");
      out.write("                btn.prop('disabled', false).text('Export Excel Rekap');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            try {\r\n");
      out.write("                const pageSize = 1000;\r\n");
      out.write("                let start = 0;\r\n");
      out.write("                let allData = [];\r\n");
      out.write("                let drawCounter = 1;\r\n");
      out.write("\r\n");
      out.write("                const headers = {\r\n");
      out.write("                    // NO: '',\r\n");
      out.write("                    KD_DIST: '',\r\n");
      out.write("                    NAMA_DIST: '',\r\n");
      out.write("                    // URUT: '',\r\n");
      out.write("                    PRODUK: '',\r\n");
      out.write("                    BANK: '',\r\n");
      out.write("                    BLN_USULAN: '',\r\n");
      out.write("                    PLN_IDPEL: '',\r\n");
      out.write("                    PLN_RPTAG: '',\r\n");
      out.write("                    PLN_LEBAR_LUNAS: '',\r\n");
      out.write("                    PLN_RPTAG_LUNAS: '',\r\n");
      out.write("                    BANK_IDPEL: '',\r\n");
      out.write("                    BANK_RPTAG: '',\r\n");
      out.write("                    SELISIH_RPTAG: ''\r\n");
      out.write("                };\r\n");
      out.write("\r\n");
      out.write("                while (true) {\r\n");
      out.write("                    const params = new URLSearchParams();\r\n");
      out.write("                    params.append('vbln_usulan', vbln_usulan);\r\n");
      out.write("\r\n");
      out.write("                    const response = await fetch(getContextPath() + '/mon-rekon-bankvsperupi', {\r\n");
      out.write("                        method: 'POST',\r\n");
      out.write("                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n");
      out.write("                        body: params.toString()\r\n");
      out.write("                    });\r\n");
      out.write("\r\n");
      out.write("                    if (!response.ok) {\r\n");
      out.write("                        const errorText = await response.text();\r\n");
      out.write("                        throw new Error('Status: ' + response.status + '\\n' + errorText);\r\n");
      out.write("                    }\r\n");
      out.write("\r\n");
      out.write("                    const json = await response.json();\r\n");
      out.write("                    const data = json.data;\r\n");
      out.write("                    if (!data || data.length === 0) break;\r\n");
      out.write("\r\n");
      out.write("                    const formatted = data.map((item, index) => {\r\n");
      out.write("                        const row = { NO: start + index + 1 };\r\n");
      out.write("                        Object.keys(headers).forEach(key => {\r\n");
      out.write("                            row[key] = item[key] || '';\r\n");
      out.write("                        });\r\n");
      out.write("                        return row;\r\n");
      out.write("                    });\r\n");
      out.write("\r\n");
      out.write("                    allData = allData.concat(formatted);\r\n");
      out.write("                    totalLoaded += data.length;\r\n");
      out.write("                    btn.text(\"Memuat... (\" + formatRibuan(totalLoaded) + \" data)\");\r\n");
      out.write("                    await new Promise(resolve => setTimeout(resolve, 10));\r\n");
      out.write("                    if (data.length < pageSize) break;\r\n");
      out.write("\r\n");
      out.write("                    start += pageSize;\r\n");
      out.write("                }\r\n");
      out.write("\r\n");
      out.write("                if (allData.length === 0) {\r\n");
      out.write("                    alert('Tidak ada data untuk diekspor!');\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("\r\n");
      out.write("                // Buat timestamp dan judul\r\n");
      out.write("                const now = new Date();\r\n");
      out.write("                const dd = String(now.getDate()).padStart(2, '0');\r\n");
      out.write("                const mm = String(now.getMonth() + 1).padStart(2, '0');\r\n");
      out.write("                const yyyy = now.getFullYear();\r\n");
      out.write("                const hh = String(now.getHours()).padStart(2, '0');\r\n");
      out.write("                const mi = String(now.getMinutes()).padStart(2, '0');\r\n");
      out.write("                const ss = String(now.getSeconds()).padStart(2, '0');\r\n");
      out.write("                const timestamp = dd + \"/\" + mm + \"/\" + yyyy + \" \" + hh + \":\" + mi + \":\" + ss;\r\n");
      out.write("                const judul1 = \"MIV REKON REKAP\";\r\n");
      out.write("\r\n");
      out.write("                // Susun data untuk Excel\r\n");
      out.write("                const rows = [];\r\n");
      out.write("                // Tambah baris judul dengan format bold\r\n");
      out.write("                rows.push([{ v: judul1, s: { font: { bold: true } } }]); // Tetap satu sel di A1\r\n");
      out.write("                rows.push([\r\n");
      out.write("                    { v: \"BULAN\", s: { font: { bold: true } } },\r\n");
      out.write("                    { v: \": \"+ vbln_usulan.substring(4, 6) + '/' + vbln_usulan.substring(0, 4)  }\r\n");
      out.write("                ]);\r\n");
      out.write("                rows.push([\r\n");
      out.write("                    { v: \"TANGGAL DOWNLOAD\", s: { font: { bold: true } } },\r\n");
      out.write("                    { v: \": \"+ timestamp}\r\n");
      out.write("                ]); // Tetap satu sel\r\n");
      out.write("                rows.push([]); // baris kosong biasa\r\n");
      out.write("                rows.push(['NO', ...Object.keys(headers)]); // header kolom biasa\r\n");
      out.write("\r\n");
      out.write("                allData.forEach(row => {\r\n");
      out.write("                    const dataRow = [\"\" + row.NO]; // NO sebagai string\r\n");
      out.write("                    Object.keys(headers).forEach(key => {\r\n");
      out.write("                        dataRow.push(row[key] || '');\r\n");
      out.write("                    });\r\n");
      out.write("                    rows.push(dataRow);\r\n");
      out.write("                });\r\n");
      out.write("\r\n");
      out.write("                // Buat worksheet dan workbook\r\n");
      out.write("                const ws = XLSX.utils.aoa_to_sheet(rows);\r\n");
      out.write("\r\n");
      out.write("                // Merge A1 sampai kolom akhir (A1-Z1 misal)\r\n");
      out.write("                // ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: Object.keys(headers).length } }];\r\n");
      out.write("\r\n");
      out.write("                // Lebar kolom\r\n");
      out.write("                ws['!cols'] = Array(Object.keys(headers).length + 1).fill({ wch: 20 });\r\n");
      out.write("\r\n");
      out.write("                // Simpan file\r\n");
      out.write("                const wb = XLSX.utils.book_new();\r\n");
      out.write("                XLSX.utils.book_append_sheet(wb, ws, 'REKAP_REKON_PLNvsBANK');\r\n");
      out.write("                const filename = \"MIV_REKON_REKAP_\" + vbln_usulan + \".xlsx\";\r\n");
      out.write("                XLSX.writeFile(wb, filename);\r\n");
      out.write("\r\n");
      out.write("            } catch (err) {\r\n");
      out.write("                alert('Terjadi error: ' + err.message);\r\n");
      out.write("                console.error(err);\r\n");
      out.write("            } finally {\r\n");
      out.write("                btn.prop('disabled', false).text('Export Excel Rekap');\r\n");
      out.write("                $('#spinnerOverlay').hide();\r\n");
      out.write("            }\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        // ---------------------------------------------------------------------------------------------\r\n");
      out.write("        // 1B-1) show Data Monitoring Detail/Detail PerUpi Modal Large \r\n");
      out.write("        // ---------------------------------------------------------------------------------------------\r\n");
      out.write("        let lastPageBeforeSearchDetail = 0;\r\n");
      out.write("\r\n");
      out.write("        $('#dataModal').on('shown.bs.modal', function () {\r\n");
      out.write("            if ($.fn.DataTable.isDataTable('#table_mondaf_upi')) {\r\n");
      out.write("                $('#table_mondaf_upi').DataTable().clear().destroy();\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            const detailTable = $('#table_mondaf_upi').DataTable({\r\n");
      out.write("                processing: true,\r\n");
      out.write("                serverSide: true,\r\n");
      out.write("                scrollX: true,\r\n");
      out.write("                ajax: {\r\n");
      out.write("                    url: getContextPath() + '/mon-rekon-bankvsperupi',\r\n");
      out.write("                    type: 'POST',\r\n");
      out.write("                    data: function (d) {\r\n");
      out.write("                        d.act         = 'detailData';\r\n");
      out.write("                        d.vbln_usulan = detailFilterParams.vbln_usulan;\r\n");
      out.write("                        d.vkd_bank    = detailFilterParams.vkd_bank;\r\n");
      out.write("                        d.vkd_dist    = detailFilterParams.vkd_dist;\r\n");
      out.write("                        console.log('Kirim data ke server:', d);\r\n");
      out.write("                    },\r\n");
      out.write("                    dataSrc: function (json) {\r\n");
      out.write("                        console.log('Response dari server:', json);\r\n");
      out.write("                        return json.data || [];\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                columns: [\r\n");
      out.write("                    {\r\n");
      out.write("                        data: null,\r\n");
      out.write("                        render: function (data, type, row, meta) {\r\n");
      out.write("                            return meta.row + meta.settings._iDisplayStart + 1;\r\n");
      out.write("                        },\r\n");
      out.write("                        className: 'text-center',\r\n");
      out.write("                        orderable: false\r\n");
      out.write("                    },\r\n");
      out.write("                    { data: 'PRODUK' },\r\n");
      out.write("                    { data: 'TGLAPPROVE' },\r\n");
      out.write("                    { data: 'KD_DIST' },\r\n");
      out.write("                    { data: 'VA' },\r\n");
      out.write("                    { data: 'SATKER' },\r\n");
      out.write("                    { data: 'PLN_NOUSULAN' },\r\n");
      out.write("                    { data: 'PLN_IDPEL' },\r\n");
      out.write("                    { data: 'PLN_BLTH' },\r\n");
      out.write("                    { data: 'PLN_LUNAS_H0' },\r\n");
      out.write("                    { data: 'PLN_RPTAG', render: data => formatNumber(data, 0) },\r\n");
      out.write("                    { data: 'PLN_RPBK', render: data => formatNumber(data, 0) },\r\n");
      out.write("                    { data: 'PLN_TGLBAYAR' },\r\n");
      out.write("                    { data: 'PLN_JAMBAYAR' },\r\n");
      out.write("                    { data: 'PLN_USERID' },\r\n");
      out.write("                    { data: 'PLN_KDBANK' },\r\n");
      out.write("                    // { data: 'BANK_KETERANGAN' },\r\n");
      out.write("                    { data: 'BANK_NOUSULAN' },\r\n");
      out.write("                    { data: 'BANK_IDPEL' },\r\n");
      out.write("                    { data: 'BANK_BLTH' },\r\n");
      out.write("                    { data: 'BANK_RPTAG', render: data => formatNumber(data, 0) },\r\n");
      out.write("                    { data: 'BANK_RPBK', render: data => formatNumber(data, 0) },\r\n");
      out.write("                    { data: 'BANK_TGLBAYAR' },\r\n");
      out.write("                    { data: 'BANK_JAMBAYAR' },\r\n");
      out.write("                    { data: 'BANK_USERID' },\r\n");
      out.write("                    { data: 'BANK_KDBANK' },\r\n");
      out.write("                    { data: 'SELISIH_RPTAG', render: data => formatNumber(data, 0) },\r\n");
      out.write("                    { data: 'SELISIH_BK', render: data => formatNumber(data, 0) },\r\n");
      out.write("                    { data: 'KETERANGAN' },\r\n");
      out.write("                ],\r\n");
      out.write("                columnDefs: [\r\n");
      out.write("                    { targets: [10, 11, 20, 21, 26, 27], className: 'dt-body-right', orderable: false }\r\n");
      out.write("                ],\r\n");
      out.write("                lengthMenu: [[10, 100, 1000], [10, 100, 1000]]\r\n");
      out.write("            });\r\n");
      out.write("\r\n");
      out.write("            // Simpan halaman terakhir saat berpindah halaman (jika tidak sedang search)\r\n");
      out.write("            detailTable.on('page.dt', function () {\r\n");
      out.write("                if (!detailTable.search()) {\r\n");
      out.write("                    lastPageBeforeSearchDetail = detailTable.page();\r\n");
      out.write("                    console.log('Halaman disimpan sebelum search:', lastPageBeforeSearchDetail);\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("\r\n");
      out.write("            // Force ke halaman 0 saat search aktif\r\n");
      out.write("            detailTable.on('preXhr.dt', function (e, settings, data) {\r\n");
      out.write("                const keyword = detailTable.search();\r\n");
      out.write("                if (keyword && keyword.length > 0) {\r\n");
      out.write("                    console.log('preXhr: sedang search, paksa ke page 0');\r\n");
      out.write("                    settings._iDisplayStart = 0;\r\n");
      out.write("                    data.start = 0;\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("\r\n");
      out.write("            // Kembali ke halaman sebelumnya saat pencarian dikosongkan\r\n");
      out.write("            detailTable.on('search.dt', function () {\r\n");
      out.write("                const keyword = detailTable.search();\r\n");
      out.write("                if (keyword.length === 0) {\r\n");
      out.write("                    console.log('Search dikosongkan, kembali ke halaman:', lastPageBeforeSearchDetail);\r\n");
      out.write("                    setTimeout(() => {\r\n");
      out.write("                        detailTable.page(lastPageBeforeSearchDetail).draw('page');\r\n");
      out.write("                    }, 300);\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        });\r\n");
      out.write("       \r\n");
      out.write("        // ----------------------------------------------------------------------------\r\n");
      out.write("        // 1B-2) Export ke exel semua data MON Detail\r\n");
      out.write("        // ----------------------------------------------------------------------------\r\n");
      out.write("        // Fungsi format angka ribuan (lokal Indonesia)\r\n");
      out.write("        const formatRibuan = (angka) => new Intl.NumberFormat('id-ID').format(angka);\r\n");
      out.write("\r\n");
      out.write("        // Ambil nama Bank MIV dari DB\r\n");
      out.write("        async function fetchNamaBank(kodeBank) {\r\n");
      out.write("            const params = new URLSearchParams();\r\n");
      out.write("            params.append('act', 'getNamaBank');\r\n");
      out.write("            params.append('kdbank', kodeBank);\r\n");
      out.write("\r\n");
      out.write("            const response = await fetch(getContextPath() + '/mon-rekon-bankvsperupi', {\r\n");
      out.write("                method: 'POST',\r\n");
      out.write("                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n");
      out.write("                body: params.toString()\r\n");
      out.write("            });\r\n");
      out.write("\r\n");
      out.write("            if (!response.ok) throw new Error(\"Gagal mengambil data bank\");\r\n");
      out.write("\r\n");
      out.write("            const json = await response.json();\r\n");
      out.write("            if (json.status !== 'success') throw new Error(\"Data bank tidak ditemukan\");\r\n");
      out.write("\r\n");
      out.write("            return json.data.NAMA_BANK || '';\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        // Ambil nama UID/UIW PLN MIV dari DB\r\n");
      out.write("        async function fetchNamaUnitUPI(kd_dist) {\r\n");
      out.write("            const params = new URLSearchParams();\r\n");
      out.write("            params.append('act', 'getNamaUnitUPI');\r\n");
      out.write("            params.append('kd_dist', kd_dist);\r\n");
      out.write("\r\n");
      out.write("            const response = await fetch(getContextPath() + '/mon-rekon-bankvsperupi', {\r\n");
      out.write("                method: 'POST',\r\n");
      out.write("                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n");
      out.write("                body: params.toString()\r\n");
      out.write("            });\r\n");
      out.write("\r\n");
      out.write("            if (!response.ok) throw new Error(\"Gagal mengambil data UNITUPI\");\r\n");
      out.write("\r\n");
      out.write("            const json = await response.json();\r\n");
      out.write("            if (json.status !== 'success') throw new Error(\"Data UNITUPI tidak ditemukan\");\r\n");
      out.write("\r\n");
      out.write("            return json.data.NAMA_DIST || '';\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        $('#btnExportMonDftAllExcelOneSheet').on('click', async function () {\r\n");
      out.write("            const btn = $(this);\r\n");
      out.write("            let totalLoaded = 0;\r\n");
      out.write("\r\n");
      out.write("            $('#spinnerOverlay').show();\r\n");
      out.write("            await new Promise(resolve => setTimeout(resolve, 30));\r\n");
      out.write("\r\n");
      out.write("            btn.prop('disabled', true).text(\"Memuat... (\" + formatRibuan(totalLoaded) + \" data)\");\r\n");
      out.write("\r\n");
      out.write("            const vbln_usulan = detailFilterParams.vbln_usulan;\r\n");
      out.write("            const vkd_bank = detailFilterParams.vkd_bank;\r\n");
      out.write("            const vkd_dist = detailFilterParams.vkd_dist;\r\n");
      out.write("\r\n");
      out.write("            if (!vbln_usulan || !vkd_bank || !vkd_dist) {\r\n");
      out.write("                alert('Silakan lengkapi filter terlebih dahulu!');\r\n");
      out.write("                btn.prop('disabled', false).text('Export Excel Per-UID/UIW');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            let namaBank = '';\r\n");
      out.write("            let namaUPI  = '';\r\n");
      out.write("            try {\r\n");
      out.write("                namaBank = await fetchNamaBank(vkd_bank);\r\n");
      out.write("                if (vkd_dist === '00') {\r\n");
      out.write("                     namaUPI  = '00 - SAKTI'\r\n");
      out.write("                } else {\r\n");
      out.write("                    namaUPI  = await fetchNamaUnitUPI(vkd_dist);\r\n");
      out.write("                }\r\n");
      out.write("                const pageSize = 1000;\r\n");
      out.write("                let start = 0;\r\n");
      out.write("                let allData = [];\r\n");
      out.write("                let drawCounter = 1;\r\n");
      out.write("\r\n");
      out.write("                const headers = {\r\n");
      out.write("                    PRODUK: '', TGLAPPROVE: '', KD_DIST: '', VA: '', SATKER: '',\r\n");
      out.write("                    PLN_NOUSULAN: '', PLN_IDPEL: '', PLN_BLTH: '', PLN_LUNAS_H0: '',\r\n");
      out.write("                    PLN_RPTAG: '', PLN_RPBK: '', PLN_TGLBAYAR: '', PLN_JAMBAYAR: '',\r\n");
      out.write("                    PLN_USERID: '', PLN_KDBANK: '', BANK_NOUSULAN: '',\r\n");
      out.write("                    BANK_IDPEL: '', BANK_BLTH: '', BANK_RPTAG: '', BANK_RPBK: '',\r\n");
      out.write("                    BANK_TGLBAYAR: '', BANK_JAMBAYAR: '', BANK_USERID: '', BANK_KDBANK: '',\r\n");
      out.write("                    SELISIH_RPTAG: '', SELISIH_BK: '', KETERANGAN: ''\r\n");
      out.write("                };\r\n");
      out.write("\r\n");
      out.write("                while (true) {\r\n");
      out.write("                    const params = new URLSearchParams();\r\n");
      out.write("                    params.append('act', 'detailData');\r\n");
      out.write("                    params.append('vbln_usulan', vbln_usulan);\r\n");
      out.write("                    params.append('vkd_bank', vkd_bank);\r\n");
      out.write("                    params.append('vkd_dist', vkd_dist);\r\n");
      out.write("                    params.append('start', start);\r\n");
      out.write("                    params.append('length', pageSize);\r\n");
      out.write("                    params.append('draw', drawCounter++);\r\n");
      out.write("                    params.append('order[0][column]', '0');\r\n");
      out.write("                    params.append('order[0][dir]', 'asc');\r\n");
      out.write("                    params.append('columns[0][data]', 'KD_DIST');\r\n");
      out.write("                    params.append('search[value]', '');\r\n");
      out.write("\r\n");
      out.write("                    const response = await fetch(getContextPath() + '/mon-rekon-bankvsperupi', {\r\n");
      out.write("                        method: 'POST',\r\n");
      out.write("                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n");
      out.write("                        body: params.toString()\r\n");
      out.write("                    });\r\n");
      out.write("\r\n");
      out.write("                    if (!response.ok) {\r\n");
      out.write("                        const errorText = await response.text();\r\n");
      out.write("                        throw new Error('Status: ' + response.status + '\\n' + errorText);\r\n");
      out.write("                    }\r\n");
      out.write("\r\n");
      out.write("                    const json = await response.json();\r\n");
      out.write("                    const data = json.data;\r\n");
      out.write("                    if (!data || data.length === 0) break;\r\n");
      out.write("\r\n");
      out.write("                    const formatted = data.map((item, index) => {\r\n");
      out.write("                        const row = { NO: start + index + 1 };\r\n");
      out.write("                        Object.keys(headers).forEach(key => {\r\n");
      out.write("                            row[key] = item[key] || '';\r\n");
      out.write("                        });\r\n");
      out.write("                        return row;\r\n");
      out.write("                    });\r\n");
      out.write("\r\n");
      out.write("                    allData = allData.concat(formatted);\r\n");
      out.write("                    totalLoaded += data.length;\r\n");
      out.write("                    btn.text(\"Memuat... (\" + formatRibuan(totalLoaded) + \" data)\");\r\n");
      out.write("                    await new Promise(resolve => setTimeout(resolve, 10));\r\n");
      out.write("                    if (data.length < pageSize) break;\r\n");
      out.write("\r\n");
      out.write("                    start += pageSize;\r\n");
      out.write("                }\r\n");
      out.write("\r\n");
      out.write("                if (allData.length === 0) {\r\n");
      out.write("                    alert('Tidak ada data untuk diekspor!');\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("\r\n");
      out.write("                // Buat timestamp dan judul\r\n");
      out.write("                const now = new Date();\r\n");
      out.write("                const dd = String(now.getDate()).padStart(2, '0');\r\n");
      out.write("                const mm = String(now.getMonth() + 1).padStart(2, '0');\r\n");
      out.write("                const yyyy = now.getFullYear();\r\n");
      out.write("                const hh = String(now.getHours()).padStart(2, '0');\r\n");
      out.write("                const mi = String(now.getMinutes()).padStart(2, '0');\r\n");
      out.write("                const ss = String(now.getSeconds()).padStart(2, '0');\r\n");
      out.write("                const timestamp = dd + \"/\" + mm + \"/\" + yyyy + \" \" + hh + \":\" + mi + \":\" + ss;\r\n");
      out.write("                const judul1 = \"MIV REKON DETAIL\";\r\n");
      out.write("\r\n");
      out.write("                // Susun data untuk Excel\r\n");
      out.write("                const rows = [];\r\n");
      out.write("                rows.push([{ v: judul1, s: { font: { bold: true } } }]); // Tetap satu sel di A1\r\n");
      out.write("                rows.push([\r\n");
      out.write("                    { v: \"BULAN\", s: { font: { bold: true } } },\r\n");
      out.write("                    { v: \": \"+ vbln_usulan.substring(4, 6) + '/' + vbln_usulan.substring(0, 4)  }\r\n");
      out.write("                ]);\r\n");
      out.write("                rows.push([\r\n");
      out.write("                    { v: \"UID/UIW\", s: { font: { bold: true } } },\r\n");
      out.write("                    { v: \": \"+ namaUPI }\r\n");
      out.write("                ]);\r\n");
      out.write("                rows.push([\r\n");
      out.write("                    { v: \"BANK MIV\", s: { font: { bold: true } } },\r\n");
      out.write("                    { v: \": \" + vkd_bank + (namaBank ? \" - \" + namaBank : '') }\r\n");
      out.write("                ]);\r\n");
      out.write("                rows.push([\r\n");
      out.write("                    { v: \"TANGGAL DOWNLOAD\", s: { font: { bold: true } } },\r\n");
      out.write("                    { v: \": \"+ timestamp}\r\n");
      out.write("                ]); // Tetap satu sel\r\n");
      out.write("                rows.push([]); // baris kosong biasa\r\n");
      out.write("                rows.push(['NO', ...Object.keys(headers)]); // header kolom biasa\r\n");
      out.write("\r\n");
      out.write("                allData.forEach(row => {\r\n");
      out.write("                    const dataRow = [\"\" + row.NO]; // NO sebagai string\r\n");
      out.write("                    Object.keys(headers).forEach(key => {\r\n");
      out.write("                        dataRow.push(row[key] || '');\r\n");
      out.write("                    });\r\n");
      out.write("                    rows.push(dataRow);\r\n");
      out.write("                });\r\n");
      out.write("\r\n");
      out.write("                // Buat worksheet dan workbook\r\n");
      out.write("                const ws = XLSX.utils.aoa_to_sheet(rows);\r\n");
      out.write("\r\n");
      out.write("                // Merge A1 sampai kolom akhir (A1-Z1 misal)\r\n");
      out.write("                // ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: Object.keys(headers).length } }];\r\n");
      out.write("\r\n");
      out.write("                // Lebar kolom\r\n");
      out.write("                ws['!cols'] = Array(Object.keys(headers).length + 1).fill({ wch: 20 });\r\n");
      out.write("\r\n");
      out.write("                // Simpan file\r\n");
      out.write("                const wb = XLSX.utils.book_new();\r\n");
      out.write("                XLSX.utils.book_append_sheet(wb, ws, 'REKON_PLNvsBANK');\r\n");
      out.write("                const filename = \"MIV_REKON_DETAIL_\" + vbln_usulan + \"_\" + vkd_bank + \"_\" + vkd_dist + \".xlsx\";\r\n");
      out.write("                XLSX.writeFile(wb, filename);\r\n");
      out.write("\r\n");
      out.write("            } catch (err) {\r\n");
      out.write("                alert('Terjadi error: ' + err.message);\r\n");
      out.write("                namaBank = '';\r\n");
      out.write("                console.error(err);\r\n");
      out.write("            } finally {\r\n");
      out.write("                btn.prop('disabled', false).text('Export Excel Per-UID/UIW');\r\n");
      out.write("                $('#spinnerOverlay').hide();\r\n");
      out.write("            }\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("    });\r\n");
      out.write("</script>\r\n");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try { out.clearBuffer(); } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
